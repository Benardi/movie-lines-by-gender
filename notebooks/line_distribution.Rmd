---
title: "Line distribution on cinema"
output:
  html_document:
    df_print: paged
    toc: yes
    toc_float: yes
  html_notebook:
    toc: yes
    toc_float: yes
---


```{r setup, echo=FALSE, warning=FALSE, message=FALSE}

library(here)
library(cluster)
library(tidyverse)
library(broom)

theme_set(theme_bw())
```

# Data Overview

```{r, warning=FALSE}
read_csv(here("data/character_list5.csv"),
                      progress = FALSE,
                      col_types = cols(
                                    script_id = col_integer(),
                                    imdb_character_name = col_character(),
                                    words = col_integer(),
                                    gender = col_character(),
                                    age = col_character()
                                    )) %>%
  mutate(age = as.numeric(age)) -> characters_list

characters_list %>% 
  glimpse()

```

```{r}
read_csv(here("data/meta_data7.csv"),
                      progress = FALSE,
         col_types = cols(
                        script_id = col_integer(),
                        imdb_id = col_character(),
                        title = col_character(),
                        year = col_integer(),
                        gross = col_integer(),
                        lines_data = col_character()
                        )) -> meta_data

meta_data %>% 
  glimpse()

```

## Combinando Dados Originais

```{r}
left_join(characters_list, 
          meta_data, 
          by=c("script_id")) %>%
  group_by(title, year) %>%
  drop_na(gross) %>%
  ungroup() -> scripts_data

scripts_data %>%
  glimpse()
```

## Words

```{r}
scripts_data %>%
  group_by(title,year) %>%
  unique() %>%
  ggplot(aes(x=words,
             y=(..count..)/sum(..count..))) +
  geom_histogram(binwidth = 250,
                 boundary = 0,
                 fill = "grey",
                 color = "black")
```

```{r}
scripts_data %>%
  group_by(title,year) %>%
  unique() %>%
  ggplot(aes(x="", 
             y=words)) +
  geom_violin(fill="grey",
               width=0.5)
```


## Female Proportion 

```{r}
scripts_data %>%
  group_by(title, year) %>%
  mutate(fem_prop = (sum(gender == "f") / n()),
         man_prop = (1 - fem_prop)) %>% 
  ungroup() -> scripts_data

scripts_data %>%
  select(title,
         year,
         fem_prop,
         man_prop) %>%
  sample_n(10)
```


```{r}
scripts_data %>%
  group_by(title,year) %>%
  unique() %>%
  ggplot(aes(x=fem_prop,
             y=(..count..)/sum(..count..))) +
  geom_histogram(binwidth = 0.05,
                 boundary = 0,
                 fill = "grey",
                 color = "black")
```

```{r}
scripts_data %>%
  group_by(title,year) %>%
  unique() %>%
  ggplot(aes(x="", 
             y=fem_prop)) +
  geom_violin(fill="grey",
               width=0.5)
```

## Movie Year 

```{r}
scripts_data %>%
  group_by(title,year) %>%
  unique() %>%
  ggplot(aes(x=year)) +
  geom_bar(fill = "grey",
           color = "black")
```

```{r}
scripts_data %>%
  group_by(title,year) %>%
  unique() %>%
  ggplot(aes(x="", 
             y=year)) +
  geom_violin(fill="grey",
               width=0.5)
```

```{r}
scripts_data %>%
  mutate(fem_words = ifelse(gender == "f",words,0),
         man_words = ifelse(gender == "m",words,0)) %>%
  group_by(title, year) %>%
  mutate(mean_fem_words = ifelse(sum(gender == "f") == 0, 0, sum(fem_words)/sum(gender == "f")),
         mean_man_words = ifelse(sum(gender == "m") == 0, 0, sum(man_words)/sum(gender == "m"))) %>% 
  ungroup()  -> scripts_data

scripts_data %>%
  select(title,
         year,
         mean_fem_words,
         mean_man_words) %>%
  sample_n(10)
```

```{r}
scripts_data %>%
  group_by(title,year) %>%
  unique() %>%
  filter(!mean_fem_words == 0) %>%
  ggplot(aes(x=mean_fem_words,
             y=(..count..)/sum(..count..))) +
  geom_histogram(binwidth = 250,
                 boundary = 0,
                 fill = "grey",
                 color = "black")
```

```{r}
scripts_data %>%
  group_by(title,year) %>%
  unique() %>%
  filter(!mean_fem_words == 0) %>%
  ggplot(aes(x="", 
             y=mean_fem_words)) +
  geom_violin(fill="grey",
               width=0.5)
```

```{r}
scripts_data %>%
  group_by(title,year) %>%
  unique() %>%
  filter(!mean_man_words == 0) %>%
  ggplot(aes(x=mean_man_words,
             y=(..count..)/sum(..count..))) +
  geom_histogram(binwidth = 250,
                 boundary = 0,
                 fill = "grey",
                 color = "black")
```

```{r}
scripts_data %>%
  group_by(title,year) %>%
  unique() %>%
  filter(!mean_man_words == 0) %>%
  ggplot(aes(x="", 
             y=mean_man_words)) +
  geom_violin(fill="grey",
               width=0.5)
```

### GAP statistic

A GAP compara a solução do agrupamento com cada k com a solução em um dataset onde não há estrutura de grupos. 

```{r}
plot_clusgap = function(clusgap, title="Gap Statistic calculation results"){
    require("ggplot2")
    gstab = data.frame(clusgap$Tab, k=1:nrow(clusgap$Tab))
    p = ggplot(gstab, aes(k, gap)) + geom_line() + geom_point(size=5)
    p = p + geom_errorbar(aes(ymax=gap+SE.sim, ymin=gap-SE.sim), width = .2)
    p = p + ggtitle(title)
    return(p)
}
```

# ```{r}
# scripts_data %>%
#   select(year) %>% 
#   clusGap(FUN = kmeans, nstart = 20, K.max = 3,B = 20) -> gaps
# plot_clusgap(gaps)
# ```

```{r}
scripts_data %>%
  group_by(title,year) %>%
  slice(1) %>%
  ungroup() %>%
  select(mean_fem_words,
         mean_man_words,
         gross) %>%
  mutate_each(funs(as.vector(scale(.)))) -> x
x
  
```


```{r}
gaps <- x %>% 
    clusGap(FUN = kmeans,
            nstart = 20,
            K.max = 8,
            B = 200,
            iter.max=30)
```

```{r}
plot_clusgap(gaps)
```

```{r}
scripts_data %>%
  group_by(title) %>%
  slice(1) %>%
  unique() %>%
  ungroup() %>%
  select(title,
         mean_fem_words,
         mean_man_words,
         gross) -> y

select(y, -title) %>%
mutate_all(funs(scale)) -> x

x
```

```{r}
# row.names(dw2.scaled)  = dw2$repository_language
# dists = dist(dw2.scaled, method = "euclidean")
# hc = hclust(dists, method = "ward.D")
# plot(hc, cex = .6)
```

```{r}
library(GGally)
data(crabs, package = "MASS")
ggparcoord(crabs, columns = 4:8, groupColumn = "sp")
```

```{r}
library(GGally)
x <- rnorm(100)
d1 <- data.frame(x1 = x, x2 = rnorm(x), x3 = x)
d2 <- mutate(d1, x3 = -x)
ggparcoord(d1)
library(lattice)
parallelplot(d1)
```

```{r}
library (vegan)
library (cluster)
library(factoextra)

data(varespec)
dis = dist(x)^2
res = kmeans(x,3)
sil = silhouette (res$cluster, dis)
plot(sil)
```

